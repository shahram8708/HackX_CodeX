{% extends "base/layout.html" %}

{% block title %}Medical Reports - HealneX{% endblock %}

{% block content %}
<div class="container">

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-file-earmark-medical text-success me-2"></i>
                        Medical Reports
                    </h2>
                    <p class="text-muted mb-0">View and download your medical documents</p>
                </div>
                {% if current_user.role == 'doctor' %}
                <a href="{{ url_for('uploads.upload_report') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>Upload Report
                </a>
                {% endif %}
            </div>
        </div>
    </div>


    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Search Reports</label>
                            <input type="text" class="form-control" name="search"
                                value="{{ request.args.get('search', '') }}" placeholder="Report type or description">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" name="report_type">
                                <option value="">All Types</option>
                                <option value="blood_test" {% if request.args.get('report_type')=='blood_test'
                                    %}selected{% endif %}>Blood Test</option>
                                <option value="x_ray" {% if request.args.get('report_type')=='x_ray' %}selected{% endif
                                    %}>X-Ray</option>
                                <option value="mri_scan" {% if request.args.get('report_type')=='mri_scan' %}selected{%
                                    endif %}>MRI Scan</option>
                                <option value="ct_scan" {% if request.args.get('report_type')=='ct_scan' %}selected{%
                                    endif %}>CT Scan</option>
                                <option value="prescription" {% if request.args.get('report_type')=='prescription'
                                    %}selected{% endif %}>Prescription</option>
                                <option value="consultation_notes" {% if
                                    request.args.get('report_type')=='consultation_notes' %}selected{% endif %}>
                                    Consultation Notes</option>
                                <option value="other" {% if request.args.get('report_type')=='other' %}selected{% endif
                                    %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" name="date_range">
                                <option value="">All Time</option>
                                <option value="last_week" {% if request.args.get('date_range')=='last_week' %}selected{%
                                    endif %}>Last Week</option>
                                <option value="last_month" {% if request.args.get('date_range')=='last_month'
                                    %}selected{% endif %}>Last Month</option>
                                <option value="last_3_months" {% if request.args.get('date_range')=='last_3_months'
                                    %}selected{% endif %}>Last 3 Months</option>
                                <option value="last_year" {% if request.args.get('date_range')=='last_year' %}selected{%
                                    endif %}>Last Year</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    {% if medical_files %}
    <div class="row">
        {% for file in medical_files %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="me-3">
                            {% if file.filename.lower().endswith('.pdf') %}
                            <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 2.5rem;"></i>
                            {% else %}
                            <i class="bi bi-file-earmark-image text-primary" style="font-size: 2.5rem;"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">{{ (file.report_type or 'Unknown').replace('_', ' ')|title }}
                            </h6>
                            <p class="text-muted small mb-2">
                                {% if current_user.role == 'patient' %}
                                Dr. {{ file.doctor.name }}
                                {% else %}
                                {{ file.patient.name }}
                                {% endif %}
                            </p>
                            <p class="text-muted small mb-0">
                                <i class="bi bi-calendar3 me-1"></i>{{ file.upload_date.strftime('%b %d, %Y') }}
                            </p>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item"
                                        href="{{ url_for('uploads.download_file', file_id=file.id) }}">
                                        <i class="bi bi-download me-2"></i>Download
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#"
                                        onclick="viewFile({{ file.id }}, '{{ file.filename }}')">
                                        <i class="bi bi-eye me-2"></i>Preview
                                    </a>
                                </li>
                                {% if current_user.role == 'doctor' or current_user.id == file.patient_id %}
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="deleteFile({{ file.id }})">
                                        <i class="bi bi-trash me-2"></i>Delete
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    {% if file.ai_analysis %}


                    <div class="modal fade" id="aiSummaryModal-{{ file.id }}" tabindex="-1"
                        aria-labelledby="aiSummaryLabel-{{ file.id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content border-info">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title" id="aiSummaryLabel-{{ file.id }}"><i
                                            class="bi bi-stars me-2"></i>AI Summary</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="markdown-{{ file.id }}"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const raw = {{ file.ai_analysis | tojson | safe
                        }};
                        const html = marked.parse(raw);
                        document.getElementById("markdown-{{ file.id }}").innerHTML = html;
});
                    </script>
                    {% endif %}
                    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {{ (file.filename|length > 20) and (file.filename[:20] + '...') or file.filename }}
                        </small>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="{{ url_for('uploads.download_file', file_id=file.id) }}"
                                class="btn btn-outline-primary" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                            <button type="button" class="btn btn-outline-success"
                                onclick="viewFile({{ file.id }}, '{{ file.filename }}')" title="Preview">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% if not file.ai_analysis %}
                            <form method="POST" action="{{ url_for('uploads.analyze_report', file_id=file.id) }}"
                                onsubmit="return disableAnalyzeButton(this, '{{ file.id }}')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-info" id="analyze-btn-{{ file.id }}">
                                    <span class="spinner-border spinner-border-sm d-none" role="status"
                                        aria-hidden="true" id="spinner-{{ file.id }}"></span>
                                    <span id="analyze-text-{{ file.id }}"><i class="bi bi-stars"></i></span>
                                </button>
                            </form>
                            {% endif %}

                            {% if file.ai_analysis %}
                            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal"
                                data-bs-target="#aiSummaryModal-{{ file.id }}">
                                <i class="bi bi-lightbulb"></i>
                            </button>
                            {% endif %}
                            <script>
                                function disableAnalyzeButton(form, fileId) {
                                    const button = document.getElementById(`analyze-btn-${fileId}`);
                                    const spinner = document.getElementById(`spinner-${fileId}`);
                                    const text = document.getElementById(`analyze-text-${fileId}`);

                                    if (button && spinner && text) {
                                        button.disabled = true;
                                        spinner.classList.remove('d-none');
                                        text.innerHTML = '';
                                    }

                                    return true;
                                }

                            </script>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


    {% if medical_files.pages > 1 %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Reports pagination">
                <ul class="pagination justify-content-center">
                    {% if medical_files.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('uploads.view_reports', page=medical_files.prev_num, **request.args) }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for page_num in medical_files.iter_pages() %}
                    {% if page_num %}
                    {% if page_num != medical_files.page %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('uploads.view_reports', page=page_num, **request.args) }}">{{ page_num
                            }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if medical_files.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('uploads.view_reports', page=medical_files.next_num, **request.args) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-file-earmark text-muted mb-3" style="font-size: 4rem;"></i>
                <h4 class="text-muted mb-3">No medical reports found</h4>
                <p class="text-muted mb-4">
                    {% if current_user.role == 'patient' %}
                    Your medical reports will appear here once your doctors upload them.
                    {% else %}
                    Start uploading medical reports for your patients.
                    {% endif %}
                </p>
                {% if current_user.role == 'doctor' %}
                <a href="{{ url_for('uploads.upload_report') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>Upload First Report
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>


<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark me-2"></i>
                    <span id="preview-title">File Preview</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="preview-content">

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="download-btn">
                    <i class="bi bi-download me-2"></i>Download
                </a>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this medical report? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <i class="bi bi-trash me-2"></i>Delete Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let fileToDelete = null;

    function viewFile(fileId, filename) {
        document.getElementById('preview-title').textContent = filename;
        document.getElementById('download-btn').href = `/uploads/download/${fileId}`;


        const previewContent = document.getElementById('preview-content');
        previewContent.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';


        if (filename.toLowerCase().endsWith('.pdf')) {
            previewContent.innerHTML = `
            <embed src="/uploads/preview/${fileId}" type="application/pdf" width="100%" height="400px" />
            <p class="text-muted mt-3">If the PDF doesn't load, <a href="/uploads/download/${fileId}">click here to download</a></p>
        `;
        } else if (filename.toLowerCase().match(/\.(jpg|jpeg|png)$/)) {
            previewContent.innerHTML = `<img src="/uploads/preview/${fileId}" class="img-fluid" alt="${filename}" />`;
        } else {
            previewContent.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-file-earmark text-muted mb-3" style="font-size: 4rem;"></i>
                <p class="text-muted">Preview not available for this file type</p>
                <a href="/uploads/download/${fileId}" class="btn btn-primary">
                    <i class="bi bi-download me-2"></i>Download File
                </a>
            </div>
        `;
        }

        new bootstrap.Modal(document.getElementById('filePreviewModal')).show();
    }

    function deleteFile(fileId) {
        fileToDelete = fileId;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    document.getElementById('confirm-delete-btn').addEventListener('click', function () {
        if (fileToDelete) {
            fetch(`/uploads/delete/${fileToDelete}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Report deleted successfully', 'success');
                        location.reload();
                    } else {
                        showToast('Error deleting report', 'error');
                    }
                })
                .catch(error => {
                    showToast('Network error', 'error');
                });

            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            fileToDelete = null;
        }
    });


    setInterval(function () {

        if (!document.querySelector('.modal.show')) {
            location.reload();
        }
    }, 30000);
</script>
{% endblock %}