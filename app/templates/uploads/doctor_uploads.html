{% extends "base/layout.html" %}
{% block title %}My Uploads{% endblock %}
{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4><i class="bi bi-files"></i> My Uploaded Files</h4>
            <a href="{{ url_for('uploads.quick_upload', patient_id=patient.id) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Quick Upload
            </a>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchFiles" placeholder="Search files...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="prescription">Prescription</option>
                        <option value="lab_result">Lab Result</option>
                        <option value="x_ray">X-Ray</option>
                        <option value="report">Report</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sortBy">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
            </div>

            {% if files %}
            <div class="row" id="fileGrid">
                {% for file in files %}
                <div class="col-md-6 col-lg-4 mb-3 file-item" data-type="{{ file.report_type }}"
                    data-name="{{ file.filename }}"
                    data-date="{{ file.upload_date.timestamp() if file.upload_date else 0 }}">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="file-icon">
                                    <i class="bi bi-file-earmark-pdf fs-2 text-danger"></i>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item"
                                                href="{{ url_for('uploads.download_file', file_id=file.id) }}">
                                                <i class="bi bi-download"></i> Download
                                            </a></li>
                                        <li><a class="dropdown-item"
                                                href="{{ url_for('uploads.preview_file', file_id=file.id) }}">
                                                <i class="bi bi-eye"></i> View
                                            </a></li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li><a class="dropdown-item text-danger" href="#"
                                                onclick="deleteFile({{ file.id }})">
                                                <i class="bi bi-trash"></i> Delete
                                            </a></li>
                                    </ul>
                                </div>
                            </div>
                            <h6 class="card-title">{{ file.filename }}</h6>
                            <p class="text-muted small">{{ file.report_type.replace('_', ' ').title() }}</p>
                            <p class="text-muted small">{{ file.description or 'No description' }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> {{ file.patient.name if file.patient else 'N/A' }}
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> {{ file.upload_date.strftime('%b %d') if
                                    file.upload_date else 'N/A' }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-file-earmark-x fs-1"></i>
                <p class="mt-3">No files uploaded yet</p>
                <a href="{{ url_for('uploads.quick_upload', patient_id=current_user.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Upload Your First File
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function deleteFile(fileId) {
        if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
            fetch(`/delete/${fileId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ file_id: fileId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('File deleted successfully!', 'success');
                        location.reload();
                    } else {
                        showToast('Failed to delete file', 'error');
                    }
                });
        }
    }


    document.getElementById('searchFiles').addEventListener('input', filterFiles);
    document.getElementById('filterType').addEventListener('change', filterFiles);
    document.getElementById('sortBy').addEventListener('change', sortFiles);

    function filterFiles() {
        const searchTerm = document.getElementById('searchFiles').value.toLowerCase();
        const filterType = document.getElementById('filterType').value;
        const fileItems = document.querySelectorAll('.file-item');

        fileItems.forEach(item => {
            const fileName = item.dataset.name.toLowerCase();
            const fileType = item.dataset.type;
            const matchesSearch = fileName.includes(searchTerm);
            const matchesType = !filterType || fileType === filterType;

            if (matchesSearch && matchesType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function sortFiles() {
        const sortBy = document.getElementById('sortBy').value;
        const fileGrid = document.getElementById('fileGrid');
        const fileItems = Array.from(document.querySelectorAll('.file-item'));

        fileItems.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return b.dataset.date - a.dataset.date;
                case 'oldest':
                    return a.dataset.date - b.dataset.date;
                case 'name':
                    return a.dataset.name.localeCompare(b.dataset.name);
                default:
                    return 0;
            }
        });

        fileItems.forEach(item => fileGrid.appendChild(item));
    }
</script>
{% endblock %}