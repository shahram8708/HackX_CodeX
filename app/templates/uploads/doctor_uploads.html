{% extends "base/layout.html" %}
{% block title %}My Uploads{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/doctor_uploads.css') }}">

<div class="container py-4 hx-upload-page hx-i18n-admin">
    <div class="row g-4">
        <div class="col-12">
            <div class="card hx-hero-card border-0 shadow-sm">
                <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3 gap-lg-4">
                    <div class="hx-hero-icon">
                        <i class="bi bi-folder2-open"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                            <span class="badge hx-badge-soft-primary"><i class="bi bi-shield-check me-1"></i>Secure library</span>
                            <span class="badge hx-badge-soft-neutral"><i class="bi bi-hdd-network me-1"></i>Cloud synced</span>
                        </div>
                        <h3 class="mb-2">My Uploaded Files</h3>
                        <p class="text-muted mb-0">Review, filter, and manage every report you have uploaded without losing context.</p>
                    </div>
                    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 ms-lg-auto">
                        <div class="hx-stat text-lg-end">
                            <span class="hx-stat-label text-muted">Total files</span>
                            <div class="hx-stat-value">{{ files|length if files else 0 }}</div>
                        </div>
                        <a href="{{ url_for('uploads.quick_upload', patient_id=patient.id) }}" class="btn btn-primary shadow-sm">
                            <i class="bi bi-plus-circle me-2"></i> Quick Upload
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card hx-filter-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="hx-chip"><i class="bi bi-magic me-1"></i> Smart filtering</span>
                            <span class="hx-chip neutral"><i class="bi bi-phone me-1"></i> Responsive</span>
                        </div>
                        <small class="text-muted">Use search, type, or sort controls to find the right file quickly.</small>
                    </div>
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-6">
                            <label class="form-label text-muted small mb-1" for="searchFiles">Search files</label>
                            <div class="input-group hx-search-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchFiles" placeholder="Search by file name or description" data-i18n-key="Search by file name or description" data-i18n-attr="placeholder">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label text-muted small mb-1" for="filterType">Filter by type</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                                <select class="form-select" id="filterType">
                                    <option value="">All Types</option>
                                    <option value="prescription">Prescription</option>
                                    <option value="lab_result">Lab Result</option>
                                    <option value="x_ray">X-Ray</option>
                                    <option value="report">Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label text-muted small mb-1" for="sortBy">Sort files</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-arrow-down-up"></i></span>
                                <select class="form-select" id="sortBy">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="name">Name A-Z</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            {% if files %}
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <span class="hx-pill"><i class="bi bi-collection me-1"></i> File library</span>
                    <span class="text-muted small">Organized grid view</span>
                </div>
                <div class="d-flex align-items-center gap-2 text-muted small">
                    <i class="bi bi-lightning-charge text-warning"></i>
                    <span>Hover cards for quick context</span>
                </div>
            </div>
            <div class="row g-3 g-lg-4" id="fileGrid">
                {% for file in files %}
                <div class="col-md-6 col-lg-4 file-item" data-type="{{ file.report_type }}" data-name="{{ file.filename }}" data-date="{{ file.upload_date.timestamp() if file.upload_date else 0 }}">
                    <div class="card h-100 hx-file-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="hx-file-icon">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </div>
                                <div class="d-flex flex-column align-items-end gap-2">
                                    <span class="badge hx-type-badge">{{ file.report_type.replace('_', ' ').title() }}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" aria-label="File actions">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                                            <li><a class="dropdown-item" href="{{ url_for('uploads.download_file', file_id=file.id) }}">
                                                    <i class="bi bi-download me-2"></i>Download
                                                </a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('uploads.preview_file', file_id=file.id) }}">
                                                    <i class="bi bi-eye me-2"></i>View
                                                </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteFile({{ file.id }})">
                                                    <i class="bi bi-trash me-2"></i>Delete
                                                </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <h6 class="mb-1 text-truncate" title="{{ file.filename }}">{{ file.filename }}</h6>
                                <p class="text-muted small mb-0 text-truncate" title="{{ file.description or 'No description' }}">{{ file.description or 'No description' }}</p>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-2 mt-auto">
                                <span class="badge hx-meta-badge"><i class="bi bi-person me-1"></i>{{ file.patient.name if file.patient else 'N/A' }}</span>
                                <span class="badge hx-meta-badge"><i class="bi bi-calendar3 me-1"></i>{{ file.upload_date.strftime('%b %d') if file.upload_date else 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card hx-empty-card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <div class="hx-empty-icon mx-auto mb-3"><i class="bi bi-file-earmark-x"></i></div>
                    <h5 class="mb-2">No files uploaded yet</h5>
                    <p class="text-muted mb-4">Upload your first report to create a secure library for your patient.</p>
                    <a href="{{ url_for('uploads.quick_upload', patient_id=current_user.id) }}" class="btn btn-primary shadow-sm">
                        <i class="bi bi-plus-circle me-2"></i> Upload Your First File
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function deleteFile(fileId) {
        if (confirm(hxInline('Are you sure you want to delete this file? This action cannot be undone.'))) {
            fetch(`/delete/${fileId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ file_id: fileId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(hxInline('File deleted successfully!'), 'success');
                        location.reload();
                    } else {
                        showToast(hxInline('Failed to delete file'), 'error');
                    }
                });
        }
    }

    function hxInline(text) {
        const lang = window.hxCurrentLanguage === 'hi' ? 'hi' : 'en';
        const map = window.hxTextTranslations?.[lang];
        return map && map[text] ? map[text] : text;
    }

    const searchInput = document.getElementById('searchFiles');
    const filterSelect = document.getElementById('filterType');
    const sortSelect = document.getElementById('sortBy');

    searchInput.addEventListener('input', filterFiles);
    filterSelect.addEventListener('change', filterFiles);
    sortSelect.addEventListener('change', sortFiles);

    function filterFiles() {
        const searchTerm = searchInput.value.toLowerCase();
        const filterType = filterSelect.value;
        const fileItems = document.querySelectorAll('.file-item');

        fileItems.forEach(item => {
            const fileName = item.dataset.name.toLowerCase();
            const fileType = item.dataset.type;
            const matchesSearch = fileName.includes(searchTerm);
            const matchesType = !filterType || fileType === filterType;

            item.classList.toggle('d-none', !(matchesSearch && matchesType));
        });
    }

    function sortFiles() {
        const sortBy = sortSelect.value;
        const fileGrid = document.getElementById('fileGrid');
        if (!fileGrid) return;
        const fileItems = Array.from(document.querySelectorAll('.file-item'));

        fileItems.sort((a, b) => {
            switch (sortBy) {
                case 'newest':
                    return b.dataset.date - a.dataset.date;
                case 'oldest':
                    return a.dataset.date - b.dataset.date;
                case 'name':
                    return a.dataset.name.localeCompare(b.dataset.name);
                default:
                    return 0;
            }
        });

        fileItems.forEach(item => fileGrid.appendChild(item));
    }

    sortFiles();
</script>
{% endblock %}