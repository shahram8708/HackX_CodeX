{% extends "base/layout.html" %}

{% block title %}Payment Checkout - HealneX{% endblock %}


{% block content %}
<script src="https://js.stripe.com/v3/"></script>
<div class="container">

    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dashboard.patient_dashboard') }}">Dashboard</a>
                    </li>
                    {% if appointment %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('appointments.my_appointments') }}">Appointments</a>
                    </li>
                    {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('payments.subscription_plans') }}">Subscription</a>
                    </li>
                    {% endif %}
                    <li class="breadcrumb-item active">Payment</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="bi bi-credit-card text-primary me-2"></i>
                Payment Checkout
            </h2>
            <p class="text-muted">Secure payment processing</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="row">

                <div class="col-md-5 order-md-2 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt me-2"></i>Order Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if appointment %}

                            <div class="d-flex align-items-start mb-3">
                                <div class="me-3">
                                    <i class="bi bi-calendar-check text-success" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Consultation with Dr. {{ appointment.doctor.name }}</h6>
                                    <p class="text-muted small mb-1">{{ appointment.doctor.specialization }}</p>
                                    <p class="text-muted small mb-1">
                                        <i class="bi bi-calendar3 me-1"></i>{{ appointment.appointment_date.strftime('%B
                                        %d, %Y') }}
                                        <i class="bi bi-clock ms-2 me-1"></i>{{
                                        appointment.appointment_time.strftime('%I:%M %p') }}
                                    </p>
                                    <span
                                        class="badge bg-{{ 'info' if appointment.appointment_type == 'teleconsultation' else 'success' }}">
                                        {{ appointment.appointment_type|title }}
                                    </span>
                                </div>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Consultation Fee</span>
                                <span>₹{{ appointment.doctor.consultation_fee }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Platform Fee</span>
                                <span>₹{{ platform_fee|default(2.99) }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Tax</span>
                                <span>₹{{ tax_amount|default(1.50) }}</span>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total Amount</strong>
                                <strong class="text-primary">₹{{ total_amount }}</strong>
                            </div>
                            {% else %}

                            <div class="d-flex align-items-start mb-3">
                                <div class="me-3">
                                    <i class="bi bi-star text-warning" style="font-size: 2rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ subscription_plan.name }} Plan</h6>
                                    <p class="text-muted small mb-2">{{ subscription_plan.description }}</p>
                                    <ul class="small text-muted mb-0">
                                        {% for feature in subscription_plan.features %}
                                        <li>{{ feature }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ subscription_plan.billing_cycle|title }} Subscription</span>
                                <span>₹{{ subscription_plan.price }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Tax</span>
                                <span>₹{{ tax_amount|default(subscription_plan.price * 0.1) }}</span>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Total Amount</strong>
                                <strong class="text-primary">₹{{ total_amount }}</strong>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Your subscription will {% if subscription_plan.billing_cycle == 'monthly' %}renew
                                    monthly{% else %}renew annually{% endif %}
                                    until cancelled.
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>


                    <div class="card border-0 bg-light mt-4">
                        <div class="card-body text-center">
                            <i class="bi bi-shield-check text-success mb-2" style="font-size: 2rem;"></i>
                            <h6 class="mb-2">Secure Payment</h6>
                            <p class="small text-muted mb-0">
                                Your payment information is encrypted and secure.
                                We use industry-standard SSL encryption.
                            </p>
                        </div>
                    </div>
                </div>


                <div class="col-md-7 order-md-1">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="bi bi-credit-card me-2"></i>Payment Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="payment-form">

                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Billing Information</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control"
                                                value="{{ current_user.name.split()[0] }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control"
                                                value="{{ current_user.name.split()[-1] if current_user.name.split()|length > 1 else '' }}">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" value="{{ current_user.email }}">
                                    </div>
                                </div>


                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Payment Method</h6>


                                    <div class="form-group mb-3">
                                        <label class="form-label">Card Information</label>
                                        <div id="card-element" class="form-control"
                                            style="height: 50px; padding: 12px;">

                                        </div>
                                        <div id="card-errors" class="text-danger mt-2" role="alert"></div>
                                    </div>


                                    <div class="d-flex gap-2 mb-3">
                                        <img src="https://img.icons8.com/color/48/000000/visa.png" alt="Visa"
                                            style="height: 30px;">
                                        <img src="https://img.icons8.com/color/48/000000/mastercard.png"
                                            alt="Mastercard" style="height: 30px;">
                                        <img src="https://img.icons8.com/color/48/000000/amex.png"
                                            alt="American Express" style="height: 30px;">
                                        <img src="https://img.icons8.com/color/48/000000/discover.png" alt="Discover"
                                            style="height: 30px;">
                                    </div>
                                </div>


                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="terms-check" required>
                                        <label class="form-check-label" for="terms-check">
                                            I agree to the <a href="#" data-bs-toggle="modal"
                                                data-bs-target="#termsModal">Terms of Service</a>
                                            and <a href="#" data-bs-toggle="modal"
                                                data-bs-target="#privacyModal">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>


                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submit-payment">
                                        <span id="button-text">
                                            <i class="bi bi-lock me-2"></i>
                                            Pay ₹{{ total_amount }} Securely
                                        </span>
                                        <div id="spinner" class="spinner-border spinner-border-sm" role="status"
                                            style="display: none;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </button>
                                </div>

                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        Powered by Stripe • Your payment is secure and encrypted
                                    </small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>By using HealneX, you agree to our terms and conditions...</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Your privacy is important to us. This policy explains how we collect and use your data...</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    const stripe = Stripe('{{ stripe_key }}');
    const elements = stripe.elements();


    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });

    cardElement.mount('#card-element');


    cardElement.on('change', function (event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });


    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function (event) {
        event.preventDefault();

        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');


        if (!document.getElementById('terms-check').checked) {
            showToast('Please accept the terms and conditions', 'error');
            return;
        }


        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';

        try {

            const { error, paymentMethod } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: '{{ current_user.name }}',
                    email: '{{ current_user.email }}',
                },
            });

            if (error) {
                showToast(error.message, 'error');
                resetButton();
                return;
            }


            const response = await fetch('{{ url_for("payments.process_appointment_payment", appointment_id=appointment.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethod.id,
                    appointment_id: {{ appointment.id }},
                amount: {{ total_amount * 100 }},
        referral_discount_applied: { { 'true' if referral_discount_applied else 'false' } }
    })

        });

    const result = await response.json();

    if (result.error) {
        showToast(result.error, 'error');
        resetButton();
    } else if (result.requires_action) {
        const { error: confirmError } = await stripe.confirmCardPayment(result.payment_intent.client_secret);

        if (confirmError) {
            showToast(confirmError.message, 'error');
            resetButton();
        } else if (result.success) {
            paymentSucceeded(result);
        } else {
            showToast('Unexpected payment status.', 'error');
            resetButton();
        }
    }
    else {

        paymentSucceeded(result);
    }
    } catch (error) {
        showToast('Payment processing failed', 'error');
        resetButton();
    }
});

    function resetButton() {
        console.log("resetButton called");
        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        spinner.style.display = 'none';
    }

    function paymentSucceeded(result) {
        showToast('Payment successful!', 'success');

        setTimeout(() => {
            window.location.href = '{{ url_for("payments.success_page") }}';
        }, 1500);
    }
</script>
{% endblock %}