{% extends "base/layout.html" %}

{% block title %}Payment Checkout - HealneX{% endblock %}


{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
<script src="https://js.stripe.com/v3/"></script>

<section class="payment-page hx-i18n-admin py-4 py-lg-5">
    <div class="container">
        <div class="row align-items-center g-3 mb-4">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-2">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('dashboard.patient_dashboard') }}" class="text-decoration-none"><i
                                    class="bi bi-house-door me-1"></i>Dashboard</a>
                        </li>
                        {% if appointment %}
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('appointments.my_appointments') }}" class="text-decoration-none"><i
                                    class="bi bi-calendar-check me-1"></i>Appointments</a>
                        </li>
                        {% else %}
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('payments.subscription_plans') }}" class="text-decoration-none"><i
                                    class="bi bi-star me-1"></i>Subscription</a>
                        </li>
                        {% endif %}
                        <li class="breadcrumb-item active">Payment</li>
                    </ol>
                </nav>
                <div class="d-flex align-items-start gap-3">
                    <div class="icon-badge">
                        <i class="bi bi-credit-card-2-front"></i>
                    </div>
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <h2 class="mb-0">Payment Checkout</h2>
                            <span class="badge bg-primary-subtle text-primary rounded-pill px-3">
                                <i class="bi bi-shield-lock me-1"></i>Secure
                            </span>
                        </div>
                        <p class="text-muted mb-0">Complete your payment with encrypted, PCI-compliant processing.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-panel d-flex align-items-center justify-content-between p-3 shadow-sm">
                    <div class="d-flex align-items-center gap-2">
                        <div class="status-dot bg-success"></div>
                        <div>
                            <small class="text-muted d-block">Status</small>
                            <strong>Ready to pay</strong>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">Total</small>
                        <span class="fs-5 fw-bold text-primary">₹{{ total_amount }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card hx-card h-100">
                    <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                            <span class="step-pill">Step 1</span>
                            <div>
                                <h5 class="mb-0">Payment Details</h5>
                                <small class="text-muted">Enter billing info and confirm your card.</small>
                            </div>
                        </div>
                        <span class="badge bg-success-subtle text-success rounded-pill">
                            <i class="bi bi-shield-check me-1"></i>SSL Secured
                        </span>
                    </div>
                    <div class="card-body">
                        <form id="payment-form" data-hx-no-spinner="true">

                            <div class="section-block mb-4">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <p class="section-label">Billing Information</p>
                                        <small class="text-muted">Prefilled from your profile for speed. Edit if
                                            needed.</small>
                                    </div>
                                    <span class="badge bg-info-subtle text-info"><i
                                            class="bi bi-person-lines-fill me-1"></i>Verified</span>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" value="{{ current_user.name.split()[0] }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control"
                                            value="{{ current_user.name.split()[-1] if current_user.name.split()|length > 1 else '' }}">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                            <input type="email" class="form-control" value="{{ current_user.email }}">
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="section-block mb-4">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div>
                                        <p class="section-label">Payment Method</p>
                                        <small class="text-muted">Card details are encrypted via Stripe.</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="chip">Visa</span>
                                        <span class="chip">Mastercard</span>
                                        <span class="chip">Amex</span>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label">Card Information</label>
                                    <div id="card-element" class="card-input"></div>
                                    <div id="card-errors" class="text-danger mt-2" role="alert"></div>
                                </div>

                                <div class="card-brands">
                                    <img src="https://img.icons8.com/color/48/000000/visa.png" alt="Visa">
                                    <img src="https://img.icons8.com/color/48/000000/mastercard.png" alt="Mastercard">
                                    <img src="https://img.icons8.com/color/48/000000/amex.png" alt="American Express">
                                    <img src="https://img.icons8.com/color/48/000000/discover.png" alt="Discover">
                                </div>
                            </div>


                            <div class="section-block mb-4">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="form-check mt-1">
                                        <input class="form-check-input" type="checkbox" id="terms-check" required>
                                    </div>
                                    <div>
                                        <p class="section-label mb-1">Terms & Privacy</p>
                                        <p class="text-muted small mb-2">Please confirm you agree to our policies before
                                            continuing.</p>
                                        <label class="form-check-label" for="terms-check">
                                            I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of
                                                Service</a>
                                            and <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>
                            </div>


                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg pay-btn" id="submit-payment">
                                    <span id="button-text" class="d-inline-flex align-items-center gap-2">
                                        <i class="bi bi-lock-fill"></i>
                                        Pay ₹{{ total_amount }} Securely
                                    </span>
                                    <div id="spinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </button>
                            </div>

                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-shield-lock me-1"></i>
                                    Powered by Stripe • Your payment is secure and encrypted
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card hx-card mb-4">
                    <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-receipt-cutoff text-primary fs-5"></i>
                            <h5 class="mb-0">Order Summary</h5>
                        </div>
                        <span class="badge bg-primary-subtle text-primary"><i class="bi bi-lightning-charge me-1"></i>Instant</span>
                    </div>
                    <div class="card-body">
                        {% if appointment %}

                        <div class="d-flex align-items-start mb-3 p-3 rounded-3 bg-light">
                            <div class="me-3">
                                <i class="bi bi-calendar-event text-success fs-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Consultation with Dr. {{ appointment.doctor.name }}</h6>
                                <p class="text-muted small mb-1">{{ appointment.doctor.specialization }}</p>
                                <p class="text-muted small mb-1 d-flex flex-wrap gap-2 align-items-center">
                                    <span><i class="bi bi-calendar3 me-1"></i>{{ appointment.appointment_date.strftime('%B %d, %Y') }}</span>
                                    <span class="vr"></span>
                                    <span><i class="bi bi-clock me-1"></i>{{ appointment.appointment_time.strftime('%I:%M %p') }}</span>
                                </p>
                                <span class="badge bg-{{ 'info' if appointment.appointment_type == 'teleconsultation' else 'success' }} rounded-pill">
                                    <i class="bi bi-camera-video me-1"></i>{{ appointment.appointment_type|title }}
                                </span>
                            </div>
                        </div>

                        <div class="summary-line">
                            <span>Consultation Fee</span>
                            <strong>₹{{ appointment.doctor.consultation_fee }}</strong>
                        </div>
                        <div class="summary-line">
                            <span>Platform Fee</span>
                            <strong>₹{{ platform_fee|default(2.99) }}</strong>
                        </div>
                        <div class="summary-line">
                            <span>Tax</span>
                            <strong>₹{{ tax_amount|default(1.50) }}</strong>
                        </div>

                        <hr>

                        <div class="summary-total">
                            <span>Total Amount</span>
                            <span class="fs-5 text-primary fw-bold">₹{{ total_amount }}</span>
                        </div>
                        {% else %}

                        <div class="d-flex align-items-start mb-3 p-3 rounded-3 bg-light">
                            <div class="me-3">
                                <i class="bi bi-star-fill text-warning fs-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ subscription_plan.name }} Plan</h6>
                                <p class="text-muted small mb-2">{{ subscription_plan.description }}</p>
                                <ul class="small text-muted mb-0 ps-3">
                                    {% for feature in subscription_plan.features %}
                                    <li>{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div class="summary-line">
                            <span>{{ subscription_plan.billing_cycle|title }} Subscription</span>
                            <strong>₹{{ subscription_plan.price }}</strong>
                        </div>
                        <div class="summary-line">
                            <span>Tax</span>
                            <strong>₹{{ tax_amount|default(subscription_plan.price * 0.1) }}</strong>
                        </div>

                        <hr>

                        <div class="summary-total">
                            <span>Total Amount</span>
                            <span class="fs-5 text-primary fw-bold">₹{{ total_amount }}</span>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                Your subscription will {% if subscription_plan.billing_cycle == 'monthly' %}renew monthly{% else %}renew annually{% endif %} until cancelled.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card hx-card border-0 bg-light">
                    <div class="card-body d-flex flex-column flex-sm-row align-items-center gap-3 text-center text-sm-start">
                        <div class="icon-circle bg-success-subtle text-success">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">Secure Payment</h6>
                            <p class="small text-muted mb-0">Your payment information is encrypted and secure. We use
                                industry-standard SSL encryption.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="badge bg-secondary-subtle text-secondary"><i class="bi bi-geo"></i> India</span>
                            <span class="badge bg-secondary-subtle text-secondary"><i class="bi bi-wifi"></i> 24/7</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms of Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>By using HealneX, you agree to our terms and conditions...</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Your privacy is important to us. This policy explains how we collect and use your data...</p>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    const stripe = Stripe('{{ stripe_key }}');
    const elements = stripe.elements();


    function showToast(message, type = 'info') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        toastContainer.appendChild(toast);

        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }


    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });

    cardElement.mount('#card-element');


    cardElement.on('change', function (event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });


    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function (event) {
        event.preventDefault();

        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');


        if (!document.getElementById('terms-check').checked) {
            showToast('Please accept the terms and conditions', 'error');
            return;
        }


        submitButton.disabled = true;
        buttonText.style.display = 'none';
        spinner.style.display = 'inline-block';

        try {

            const { error, paymentMethod } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: '{{ current_user.name }}',
                    email: '{{ current_user.email }}',
                },
            });

            if (error) {
                showToast(error.message, 'error');
                resetButton();
                return;
            }


            const response = await fetch('{{ url_for("payments.process_appointment_payment", appointment_id=appointment.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethod.id,
                    appointment_id: {{ appointment.id }},
                    amount: {{ total_amount * 100 }},
                    referral_discount_applied: {{ 'true' if referral_discount_applied else 'false' }}
                })
            });

    const result = await response.json();

    if (result.error) {
        showToast(result.error, 'error');
        resetButton();
    } else if (result.requires_action) {
        const { error: confirmError } = await stripe.confirmCardPayment(result.payment_intent.client_secret);

        if (confirmError) {
            showToast(confirmError.message, 'error');
            resetButton();
        } else if (result.success) {
            paymentSucceeded(result);
        } else {
            showToast('Unexpected payment status.', 'error');
            resetButton();
        }
    }
    else {

        paymentSucceeded(result);
    }
    } catch (error) {
        showToast('Payment processing failed', 'error');
        resetButton();
    }
});

    function resetButton() {
        console.log("resetButton called");
        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        submitButton.disabled = false;
        buttonText.style.display = 'inline';
        spinner.style.display = 'none';
    }

    function paymentSucceeded(result) {
        showToast('Payment successful!', 'success');

        setTimeout(() => {
            window.location.href = '{{ url_for("appointments.my_appointments") }}';
        }, 1500);
    }
</script>
{% endblock %}