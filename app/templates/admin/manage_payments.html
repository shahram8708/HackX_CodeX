{% extends "base/layout.html" %}
{% block title %}Payment Management - HealneX{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_manage_payments.css') }}">

<div class="container-fluid hx-manage-payments hx-i18n-admin py-4">
    <div class="row g-4 mb-2">
        <div class="col-12">
            <div class="card hx-hero-card shadow-lg border-0 overflow-hidden">
                <div class="card-body p-4 p-lg-5 d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="hx-hero-pill"><i class="bi bi-credit-card-2-front me-2"></i>Payment Management</span>
                            <span class="badge bg-light text-dark fw-semibold">Financial Control</span>
                        </div>
                        <h1 class="text-white fw-bold mb-2">Track every transaction with clarity.</h1>
                        <p class="text-white-50 mb-0">Monitor revenue streams, statuses, and receipts in one organized workspace.</p>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="badge bg-white text-dark px-3 py-2 shadow-sm"><i class="bi bi-currency-rupee text-primary me-1"></i>₹{{ total_revenue|default(0) }} Total</span>
                        <span class="badge bg-white text-dark px-3 py-2 shadow-sm"><i class="bi bi-shield-check text-success me-1"></i>{{ failed_payments|default(0) }} Failed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card hx-stat-card shadow-sm h-100">
                <div class="hx-stat-accent bg-success"></div>
                <div class="card-body text-center">
                    <div class="hx-stat-icon bg-success-subtle text-success mb-2"><i class="bi bi-currency-rupee"></i></div>
                    <h3 class="fw-bold mb-1">₹{{ total_revenue|default(0) }}</h3>
                    <p class="text-muted mb-0 small">Total Revenue</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card hx-stat-card shadow-sm h-100">
                <div class="hx-stat-accent bg-primary"></div>
                <div class="card-body text-center">
                    <div class="hx-stat-icon bg-primary-subtle text-primary mb-2"><i class="bi bi-people"></i></div>
                    <h3 class="fw-bold mb-1">₹{{ consultation_revenue|default(0) }}</h3>
                    <p class="text-muted mb-0 small">Consultation Revenue</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card hx-stat-card shadow-sm h-100">
                <div class="hx-stat-accent bg-info"></div>
                <div class="card-body text-center">
                    <div class="hx-stat-icon bg-info-subtle text-info mb-2"><i class="bi bi-repeat"></i></div>
                    <h3 class="fw-bold mb-1">₹{{ subscription_revenue|default(0) }}</h3>
                    <p class="text-muted mb-0 small">Subscription Revenue</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card hx-stat-card shadow-sm h-100">
                <div class="hx-stat-accent bg-warning"></div>
                <div class="card-body text-center">
                    <div class="hx-stat-icon bg-warning-subtle text-warning mb-2"><i class="bi bi-x-circle"></i></div>
                    <h3 class="fw-bold mb-1">{{ failed_payments|default(0) }}</h3>
                    <p class="text-muted mb-0 small">Failed Payments</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card hx-filter-card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="hx-dot bg-primary"></span>
                    <div>
                        <p class="text-muted small mb-0">Quick Filters</p>
                        <h5 class="mb-0">Refine transactions by type, status, or time</h5>
                    </div>
                </div>
                <span class="badge bg-primary-subtle text-primary px-3 py-2">Live data</span>
            </div>
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Search</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0" name="search" value="{{ request.args.get('search', '') }}" placeholder="User name or Payment ID">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Type</label>
                    <select class="form-select" name="type">
                        <option value="">All Types</option>
                        <option value="consultation" {% if request.args.get('type')=='consultation' %}selected{% endif %}>Consultation</option>
                        <option value="subscription" {% if request.args.get('type')=='subscription' %}selected{% endif %}>Subscription</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-semibold">Status</label>
                    <select class="form-select" name="status">
                        <option value="">All Status</option>
                        <option value="completed" {% if request.args.get('status')=='completed' %}selected{% endif %}>Completed</option>
                        <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>Pending</option>
                        <option value="failed" {% if request.args.get('status')=='failed' %}selected{% endif %}>Failed</option>
                        <option value="refunded" {% if request.args.get('status')=='refunded' %}selected{% endif %}>Refunded</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Date Range</label>
                    <select class="form-select" name="date_range">
                        <option value="">All Time</option>
                        <option value="today" {% if request.args.get('date_range')=='today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if request.args.get('date_range')=='week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if request.args.get('date_range')=='month' %}selected{% endif %}>This Month</option>
                        <option value="quarter" {% if request.args.get('date_range')=='quarter' %}selected{% endif %}>This Quarter</option>
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary shadow-sm">
                        <i class="bi bi-funnel me-2"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <span class="hx-dot bg-success"></span>
                <h5 class="mb-0">Payment Transactions</h5>
                <span class="badge bg-success-subtle text-success">{{ payments.items|length if payments.items is defined else payments|length }} records</span>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm shadow-sm" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 hx-payments-table">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Payment ID</th>
                            <th scope="col">Date</th>
                            <th scope="col">User</th>
                            <th scope="col">Type</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td class="fw-semibold text-dark">
                                <span class="badge bg-dark-subtle text-dark fw-semibold px-3 py-2 rounded-pill"><i class="bi bi-hash me-1"></i>{{ payment.payment_id or payment.id }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="hx-date-chip text-primary"><i class="bi bi-calendar3 me-1"></i>{{ payment.payment_date.strftime('%b %d, %Y') }}</div>
                                    <small class="text-muted">{{ payment.payment_date.strftime('%I:%M %p') }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">{{ payment.user.name }}</span>
                                    <small class="text-muted">{{ payment.user.email }}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge hx-type-badge bg-{{ 'primary' if payment.payment_type == 'consultation' else 'info' }}">
                                    <i class="bi bi-{{ 'person-video' if payment.payment_type == 'consultation' else 'repeat' }} me-1"></i>
                                    {{ payment.payment_type|title }}
                                </span>
                            </td>
                            <td>
                                <strong class="text-success">₹{{ '%.2f'|format(payment.amount) }}</strong>
                            </td>
                            <td>
                                <span class="badge hx-status-badge bg-{{ 
                                'success' if payment.status == 'completed' 
                                else 'warning' if payment.status == 'pending' 
                                else 'danger' if payment.status == 'failed' 
                                else 'secondary' }}">
                                    <i class="bi bi-{{ 
                                    'check-circle' if payment.status == 'completed' 
                                    else 'hourglass-split' if payment.status == 'pending' 
                                    else 'x-circle' if payment.status == 'failed' 
                                    else 'question-circle' }} me-1"></i>
                                    {{ payment.status|title }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info shadow-sm" title="View Details" onclick="viewPayment({{ payment.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a href="{{ url_for('payments.view_receipt', payment_id=payment.id) }}" class="btn btn-outline-success shadow-sm" title="Download Receipt">
                                        <i class="bi bi-download"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
<script src="{{ url_for('static', filename='js/button_spinner.js') }}"></script>
<script>
    function viewPayment(paymentId) {
        window.location.href = `/payments/receipt/${paymentId}`;
    }

</script>
{% endblock %}