{% extends "base/layout.html" %}

{% block title %}Book Appointment - HealneX{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/book_appointment.css') }}">

<section class="book-shell hx-i18n-admin py-4 py-lg-5">
    <div class="container">

        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb" class="breadcrumb-card p-3">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a class="d-flex align-items-center gap-2"
                                href="{{ url_for('dashboard.patient_dashboard') }}">
                                <i class="bi bi-house-door-fill"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-muted" aria-current="page">
                            <i class="bi bi-calendar-plus"></i>
                            <span>Book Appointment</span>
                        </li>
                    </ol>
                </nav>

                <div class="card border-0 shadow-sm hero-card mt-3">
                    <div class="card-body p-4 p-lg-5 d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
                        <div>
                            <div class="d-inline-flex align-items-center gap-2 text-uppercase text-muted small mb-2">
                                <span class="badge bg-light text-primary rounded-pill px-3 py-2">
                                    <i class="bi bi-calendar-week me-1"></i> Quick booking
                                </span>
                            </div>
                            <h2 class="mb-1">
                                <i class="bi bi-calendar-plus text-primary me-2"></i>
                                Book an Appointment
                            </h2>
                            <p class="text-muted mb-0">Find a doctor, pick a time, and confirm in seconds.</p>
                        </div>
                        <div class="mt-2 mt-lg-0">
                            <a href="{{ url_for('appointments.my_appointments') }}" class="btn btn-outline-primary btn-lg shadow-sm">
                                <i class="bi bi-clock-history me-1"></i> View My Appointments
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm filter-card">
                    <div class="card-body p-4">
                        <form method="GET" id="doctor-search-form">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Search Doctors</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" name="search"
                                            value="{{ request.args.get('search', '') }}"
                                            placeholder="Doctor name or specialization">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Specialization</label>
                                    <select class="form-select" name="specialization">
                                        <option value="">All Specializations</option>
                                        {% for spec in specializations %}
                                        <option value="{{ spec }}" {% if request.args.get('specialization')==spec %}selected{% endif %}>
                                            {{ spec }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Consultation Type</label>
                                    <select class="form-select" name="consultation_type">
                                        <option value="">Both</option>
                                        <option value="in_person" {% if request.args.get('consultation_type')=='in_person' %}selected{% endif %}>
                                            In-Person
                                        </option>
        <option value="teleconsultation" {% if request.args.get('consultation_type')=='teleconsultation' %}selected{% endif %}>
                                            Teleconsultation
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-funnel me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <div class="row g-4">
            {% if doctors %}
            {% for doctor in doctors %}
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100 doctor-card">
                    <div class="card-body d-flex flex-column h-100">
                        <div class="d-flex gap-3 align-items-start">
                            <div class="avatar-circle bg-primary text-white">{{ doctor.name[0].upper() }}</div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                    <div>
                                        <h5 class="mb-1">Dr. {{ doctor.name }}</h5>
                                        <p class="text-primary mb-1">{{ doctor.specialization }}</p>
                                    </div>
                                    <span class="badge bg-light text-dark rounded-pill">{{ doctor.license_number }}</span>
                                </div>
                                <p class="text-muted small mb-1"><i class="bi bi-building me-1"></i>{{ doctor.clinic_hospital }}</p>
                                <p class="text-muted small mb-0"><i class="bi bi-clock me-1"></i>{{ doctor.working_hours_start.strftime('%I:%M %p') }} - {{ doctor.working_hours_end.strftime('%I:%M %p') }}</p>
                            </div>
                        </div>

                        <div class="row mt-3 g-3">
                            <div class="col-sm-6">
                                <div class="info-tile">
                                    <span class="icon-circle bg-success-subtle text-success"><i class="bi bi-currency-rupee"></i></span>
                                    <div>
                                        <small class="text-muted">Consultation Fee</small>
                                        <div class="fw-semibold">₹{{ doctor.consultation_fee }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="info-tile">
                                    <span class="icon-circle bg-info-subtle text-info"><i class="bi bi-laptop"></i></span>
                                    <div>
                                        <small class="text-muted">Consultation Type</small>
                                        <div class="fw-semibold">In-person & Online</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-auto pt-3">
                            <button type="button" class="btn btn-primary w-100" onclick="bookAppointment({{ doctor.id }}, '{{ doctor.name }}', {{ doctor.consultation_fee }},
                                 '{{ doctor.working_hours_start.strftime('%H:%M') }}',
                                 '{{ doctor.working_hours_end.strftime('%H:%M') }}')">
                                <i class="bi bi-calendar-plus me-2"></i>Book Appointment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="col-12">
                <div class="empty-state text-center py-5">
                    <div class="empty-icon bg-primary-subtle text-primary"><i class="bi bi-search"></i></div>
                    <h4 class="mt-3 mb-2">No doctors found</h4>
                    <p class="text-muted mb-3">Try adjusting your search criteria</p>
                    <a href="{{ url_for('appointments.book_appointment') }}" class="btn btn-primary">
                        View All Doctors
                    </a>
                </div>
            </div>
            {% endif %}
        </div>


        {% if doctors.pages > 1 %}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Doctors pagination">
                    <ul class="pagination justify-content-center pagination-modern">
                        {% if doctors.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('appointments.book_appointment', page=doctors.prev_num, **request.args) }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for page_num in doctors.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != doctors.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('appointments.book_appointment', page=page_num, **request.args) }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if doctors.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('appointments.book_appointment', page=doctors.next_num, **request.args) }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</section>


<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-plus me-2"></i>Book Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="booking-form">
                {{ booking_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info border-0 rounded-3 shadow-sm">
                                <strong>Doctor:</strong> <span id="selected-doctor-name"></span><br>
                                <strong>Consultation Fee:</strong> ₹<span id="selected-doctor-fee"></span>
                            </div>
                        </div>
                    </div>

                    {{ booking_form.doctor_id(type="hidden") }}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ booking_form.appointment_type.label(class="form-label") }}
                            {{ booking_form.appointment_type(class="form-select") }}
                        </div>
                        <div class="col-md-6">
                            {{ booking_form.appointment_date.label(class="form-label") }}
                            {{ booking_form.appointment_date(class="form-control", min=today_date) }}
                        </div>
                    </div>
                    <div class="row mb-3" id="payment-method-row">
                        <div class="col-md-6">
                            {{ booking_form.payment_method.label(class="form-label") }}
                            {{ booking_form.payment_method(class="form-select") }}
                        </div>
                    </div>
                    <script>
                        document.querySelector('select[name="appointment_type"]').addEventListener('change', function () {
                            const paymentSelect = document.querySelector('select[name="payment_method"]');
                            const selectedType = this.value;

                            paymentSelect.innerHTML = '';

                            if (selectedType === 'in-person') {
                                paymentSelect.innerHTML += '<option value="online">Online</option>';
                                paymentSelect.innerHTML += '<option value="offline">Offline</option>';
                            } else if (selectedType === 'teleconsultation') {
                                paymentSelect.innerHTML += '<option value="online">Online</option>';
                            }
                        });

                    </script>
                    <div class="row mb-3">
                        <div class="col-12">
                            {{ booking_form.appointment_time.label(class="form-label") }}
                            <div id="time-slots" class="d-flex flex-wrap gap-2">

                            </div>
                            {{ booking_form.appointment_time(type="hidden") }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            {{ booking_form.reason.label(class="form-label") }}
                            {{ booking_form.reason(class="form-control", rows="3", placeholder="Brief description of
                            your health concern (optional)") }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/button_spinner.js') }}"></script>
<script>

    const timeSlots = [
        '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00'
    ];

    function bookAppointment(id, name, fee, startTime, endTime) {
        document.getElementById('selected-doctor-name').textContent = name;
        document.getElementById('selected-doctor-fee').textContent = fee;
        document.querySelector('input[name="doctor_id"]').value = id;
        document.getElementById('booking-form').dataset.startTime = startTime;
        document.getElementById('booking-form').dataset.endTime = endTime;

        document.getElementById('booking-form').reset();
        document.querySelector('input[name="doctor_id"]').value = id;

        const dateInput = document.querySelector('input[name="appointment_date"]');
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;

        fetch(`/appointments/api/available_times/${id}/${today}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('time-slots');
                container.innerHTML = '';

                if (data.times && data.times.length) {
                    data.times.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm time-slot';
                        btn.textContent = slot[1];
                        btn.dataset.time = slot[0];
                        btn.onclick = () => selectTimeSlot(btn);
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            })
            .catch(() => {
                document.getElementById('time-slots').innerHTML = '<span class="text-danger">Error loading slots</span>';
            });

        new bootstrap.Modal(document.getElementById('bookingModal')).show();
        document.getElementById('booking-form').action = `/appointments/book/${id}`;
    }

    function generateTimeSlots(start, end) {
        const timeSlotsContainer = document.getElementById('time-slots');
        timeSlotsContainer.innerHTML = '';

        const [sh, sm] = start.split(':').map(Number);
        const [eh, em] = end.split(':').map(Number);
        const startDate = new Date(0, 0, 0, sh, sm);
        const endDate = new Date(0, 0, 0, eh, em);

        while (startDate <= endDate) {
            const hours = startDate.getHours().toString().padStart(2, '0');
            const minutes = startDate.getMinutes().toString().padStart(2, '0');
            const time24 = `${hours}:${minutes}`;
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-outline-primary btn-sm time-slot';
            button.textContent = formatTime(time24);
            button.dataset.time = time24;
            button.onclick = () => selectTimeSlot(button);
            timeSlotsContainer.appendChild(button);

            startDate.setMinutes(startDate.getMinutes() + 30);
        }
    }

    function selectTimeSlot(button) {

        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('btn-primary');
            slot.classList.add('btn-outline-primary');
        });


        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');


        document.querySelector('input[name="appointment_time"]').value = button.dataset.time;
    }

    function formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }


    document.getElementById('booking-form').addEventListener('submit', function (e) {
        const selectedTime = document.querySelector('input[name="appointment_time"]').value;
        const selectedDate = document.querySelector('input[name="appointment_date"]').value;

        if (!selectedTime) {
            e.preventDefault();
            showToast('Please select an appointment time', 'error');
            return false;
        }

        if (!selectedDate) {
            e.preventDefault();
            showToast('Please select an appointment date', 'error');
            return false;
        }


        const today = new Date().toISOString().split('T')[0];
        if (selectedDate < today) {
            e.preventDefault();
            showToast('Please select a future date', 'error');
            return false;
        }
    });

    document.querySelector('input[name="appointment_date"]').addEventListener('change', function () {
        const date = this.value;
        const doctorId = document.querySelector('input[name="doctor_id"]').value;

        if (!date || !doctorId) return;

        const container = document.getElementById('time-slots');
        container.innerHTML = '<span class="text-muted">Loading...</span>';

        fetch(`/appointments/api/available_times/${doctorId}/${date}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';

                if (data.times && data.times.length) {
                    data.times.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm time-slot';
                        btn.textContent = slot[1];
                        btn.dataset.time = slot[0];
                        btn.onclick = () => selectTimeSlot(btn);
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            })
            .catch(() => {
                container.innerHTML = '<span class="text-danger">Failed to load slots</span>';
            });
    });

</script>
{% endblock %}