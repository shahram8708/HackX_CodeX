{% extends "base/layout.html" %}

{% block title %}Book Appointment - HealneX{% endblock %}

{% block content %}
<div class="container">

    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-light rounded p-2 shadow-sm">
                    <li class="breadcrumb-item">
                        <a class="text-decoration-none d-flex align-items-center gap-2"
                            href="{{ url_for('dashboard.patient_dashboard') }}">
                            <i class="bi bi-house-door text-primary"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item active text-muted" aria-current="page">
                        <i class="bi bi-calendar-plus text-secondary"></i>
                        Book Appointment
                    </li>
                </ol>
            </nav>

            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-calendar-plus text-primary me-2"></i>
                        Book an Appointment
                    </h2>
                    <p class="text-muted mb-0">Easily schedule consultations with our verified doctors</p>
                </div>
                <div class="mt-3 mt-md-0">
                    <a href="{{ url_for('appointments.my_appointments') }}" class="btn btn-outline-primary shadow-sm">
                        <i class="bi bi-clock-history me-1"></i> View My Appointments
                    </a>
                </div>
            </div>
        </div>
    </div>


    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="GET" id="doctor-search-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Search Doctors</label>
                                <input type="text" class="form-control" name="search"
                                    value="{{ request.args.get('search', '') }}"
                                    placeholder="Doctor name or specialization">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Specialization</label>
                                <select class="form-select" name="specialization">
                                    <option value="">All Specializations</option>
                                    {% for spec in specializations %}
                                    <option value="{{ spec }}" {% if request.args.get('specialization')==spec
                                        %}selected{% endif %}>
                                        {{ spec }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Consultation Type</label>
                                <select class="form-select" name="consultation_type">
                                    <option value="">Both</option>
                                    <option value="in_person" {% if request.args.get('consultation_type')=='in_person'
                                        %}selected{% endif %}>
                                        In-Person
                                    </option>
                                    <option value="teleconsultation" {% if
                                        request.args.get('consultation_type')=='teleconsultation' %}selected{% endif %}>
                                        Teleconsultation
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        {% if doctors %}
        {% for doctor in doctors %}
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="row">
                        <div class="col-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto"
                                style="width: 60px; height: 60px; font-size: 1.5rem;">
                                {{ doctor.name[0].upper() }}
                            </div>
                        </div>
                        <div class="col-9">
                            <h5 class="card-title mb-1">Dr. {{ doctor.name }}</h5>
                            <p class="text-primary mb-1">{{ doctor.specialization }}</p>
                            <p class="text-muted small mb-2">
                                <i class="bi bi-building me-1"></i>{{ doctor.clinic_hospital }}
                            </p>
                            <p class="text-muted small mb-2">
                                <i class="bi bi-clock me-1"></i>{{ doctor.working_hours_start.strftime('%I:%M %p') }} -
                                {{ doctor.working_hours_end.strftime('%I:%M %p') }}
                            </p>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="row align-items-center">
                        <div class="col-6">
                            <div class="text-center">
                                <h6 class="text-success mb-1">₹{{ doctor.consultation_fee }}</h6>
                                <small class="text-muted">Consultation Fee</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <span class="badge bg-info">{{ doctor.license_number }}</span><br>
                                <small class="text-muted">License #</small>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="bookAppointment({{ doctor.id }}, '{{ doctor.name }}', {{ doctor.consultation_fee }},
                             '{{ doctor.working_hours_start.strftime('%H:%M') }}',
                             '{{ doctor.working_hours_end.strftime('%H:%M') }}')">
                            <i class="bi bi-calendar-plus me-2"></i>Book Appointment
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-search text-muted mb-3" style="font-size: 4rem;"></i>
                <h4 class="text-muted mb-3">No doctors found</h4>
                <p class="text-muted mb-4">Try adjusting your search criteria</p>
                <a href="{{ url_for('appointments.book_appointment') }}" class="btn btn-primary">
                    View All Doctors
                </a>
            </div>
        </div>
        {% endif %}
    </div>


    {% if doctors.pages > 1 %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Doctors pagination">
                <ul class="pagination justify-content-center">
                    {% if doctors.has_prev %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('appointments.book_appointment', page=doctors.prev_num, **request.args) }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for page_num in doctors.iter_pages() %}
                    {% if page_num %}
                    {% if page_num != doctors.page %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('appointments.book_appointment', page=page_num, **request.args) }}">{{
                            page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if doctors.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="{{ url_for('appointments.book_appointment', page=doctors.next_num, **request.args) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>


<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-plus me-2"></i>Book Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="booking-form">
                {{ booking_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info border-0">
                                <strong>Doctor:</strong> <span id="selected-doctor-name"></span><br>
                                <strong>Consultation Fee:</strong> ₹<span id="selected-doctor-fee"></span>
                            </div>
                        </div>
                    </div>

                    {{ booking_form.doctor_id(type="hidden") }}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ booking_form.appointment_type.label(class="form-label") }}
                            {{ booking_form.appointment_type(class="form-select") }}
                        </div>
                        <div class="col-md-6">
                            {{ booking_form.appointment_date.label(class="form-label") }}
                            {{ booking_form.appointment_date(class="form-control", min=today_date) }}
                        </div>
                    </div>
                    <div class="row mb-3" id="payment-method-row">
                        <div class="col-md-6">
                            {{ booking_form.payment_method.label(class="form-label") }}
                            {{ booking_form.payment_method(class="form-select") }}
                        </div>
                    </div>
                    <script>
                        document.querySelector('select[name="appointment_type"]').addEventListener('change', function () {
                            const paymentSelect = document.querySelector('select[name="payment_method"]');
                            const selectedType = this.value;

                            paymentSelect.innerHTML = '';

                            if (selectedType === 'in-person') {
                                paymentSelect.innerHTML += '<option value="online">Online</option>';
                                paymentSelect.innerHTML += '<option value="offline">Offline</option>';
                            } else if (selectedType === 'teleconsultation') {
                                paymentSelect.innerHTML += '<option value="online">Online</option>';
                            }
                        });

                    </script>
                    <div class="row mb-3">
                        <div class="col-12">
                            {{ booking_form.appointment_time.label(class="form-label") }}
                            <div id="time-slots" class="d-flex flex-wrap gap-2">

                            </div>
                            {{ booking_form.appointment_time(type="hidden") }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            {{ booking_form.reason.label(class="form-label") }}
                            {{ booking_form.reason(class="form-control", rows="3", placeholder="Brief description of
                            your health concern (optional)") }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

    const timeSlots = [
        '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00'
    ];

    function bookAppointment(id, name, fee, startTime, endTime) {
        document.getElementById('selected-doctor-name').textContent = name;
        document.getElementById('selected-doctor-fee').textContent = fee;
        document.querySelector('input[name="doctor_id"]').value = id;
        document.getElementById('booking-form').dataset.startTime = startTime;
        document.getElementById('booking-form').dataset.endTime = endTime;

        document.getElementById('booking-form').reset();
        document.querySelector('input[name="doctor_id"]').value = id;

        const dateInput = document.querySelector('input[name="appointment_date"]');
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;

        fetch(`/appointments/api/available_times/${id}/${today}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('time-slots');
                container.innerHTML = '';

                if (data.times && data.times.length) {
                    data.times.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm time-slot';
                        btn.textContent = slot[1];
                        btn.dataset.time = slot[0];
                        btn.onclick = () => selectTimeSlot(btn);
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            })
            .catch(() => {
                document.getElementById('time-slots').innerHTML = '<span class="text-danger">Error loading slots</span>';
            });

        new bootstrap.Modal(document.getElementById('bookingModal')).show();
        document.getElementById('booking-form').action = `/appointments/book/${id}`;
    }

    function generateTimeSlots(start, end) {
        const timeSlotsContainer = document.getElementById('time-slots');
        timeSlotsContainer.innerHTML = '';

        const [sh, sm] = start.split(':').map(Number);
        const [eh, em] = end.split(':').map(Number);
        const startDate = new Date(0, 0, 0, sh, sm);
        const endDate = new Date(0, 0, 0, eh, em);

        while (startDate <= endDate) {
            const hours = startDate.getHours().toString().padStart(2, '0');
            const minutes = startDate.getMinutes().toString().padStart(2, '0');
            const time24 = `${hours}:${minutes}`;
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-outline-primary btn-sm time-slot';
            button.textContent = formatTime(time24);
            button.dataset.time = time24;
            button.onclick = () => selectTimeSlot(button);
            timeSlotsContainer.appendChild(button);

            startDate.setMinutes(startDate.getMinutes() + 30);
        }
    }

    function selectTimeSlot(button) {

        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('btn-primary');
            slot.classList.add('btn-outline-primary');
        });


        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');


        document.querySelector('input[name="appointment_time"]').value = button.dataset.time;
    }

    function formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12}:${minutes} ${ampm}`;
    }


    document.getElementById('booking-form').addEventListener('submit', function (e) {
        const selectedTime = document.querySelector('input[name="appointment_time"]').value;
        const selectedDate = document.querySelector('input[name="appointment_date"]').value;

        if (!selectedTime) {
            e.preventDefault();
            showToast('Please select an appointment time', 'error');
            return false;
        }

        if (!selectedDate) {
            e.preventDefault();
            showToast('Please select an appointment date', 'error');
            return false;
        }


        const today = new Date().toISOString().split('T')[0];
        if (selectedDate < today) {
            e.preventDefault();
            showToast('Please select a future date', 'error');
            return false;
        }
    });

    document.querySelector('input[name="appointment_date"]').addEventListener('change', function () {
        const date = this.value;
        const doctorId = document.querySelector('input[name="doctor_id"]').value;

        if (!date || !doctorId) return;

        const container = document.getElementById('time-slots');
        container.innerHTML = '<span class="text-muted">Loading...</span>';

        fetch(`/appointments/api/available_times/${doctorId}/${date}`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = '';

                if (data.times && data.times.length) {
                    data.times.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-primary btn-sm time-slot';
                        btn.textContent = slot[1];
                        btn.dataset.time = slot[0];
                        btn.onclick = () => selectTimeSlot(btn);
                        container.appendChild(btn);
                    });
                } else {
                    container.innerHTML = '<span class="text-muted">No slots available</span>';
                }
            })
            .catch(() => {
                container.innerHTML = '<span class="text-danger">Failed to load slots</span>';
            });
    });

</script>
{% endblock %}